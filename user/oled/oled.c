#ifdef OLED_KEYLOGGER_ENABLE
#include "keylogger.c"
#endif
#include "pet.c"
#include "vtvz.h"
#include <stdio.h>

oled_rotation_t oled_init_user(oled_rotation_t rotation) {
  return OLED_ROTATION_270;
}

void oled_render_layer_state(uint8_t col, uint8_t line) {
  oled_set_cursor(col, line);
  oled_write("Layer", false);

  oled_set_cursor(col, line + 1);
  switch (get_highest_layer(layer_state)) {
  case _BASE:
    oled_write("Qwert", false);
    break;
  case _COLEMAK_DH:
    oled_write("CmkDH", false);
    break;
  case _EXTRA2:
    oled_write("Extra", false);
    break;
  case _NUM:
    oled_write("NumNv", false);
    break;
  case _SYMB:
    oled_write("Symbl", false);
    break;
  case _FN:
    oled_write("Fn&Ms", false);
    break;
#ifdef ZOOM_MODE
  case _ZOOM:
    oled_write("Zooom", false);
    break;
#endif
  default:
    oled_write("Dunno", false);
  }
}

#ifdef OLED_KEYLOGGER_ENABLE
void oled_render_keylog(uint8_t col, uint8_t line) {
  if (is_keylog_enabled()) {
#if OLED_TIMEOUT > 0
    /* the animation prevents the normal timeout from occuring */
    if (last_input_activity_elapsed() > OLED_TIMEOUT &&
        last_led_activity_elapsed() > OLED_TIMEOUT) {
      oled_off();
      return;
    } else {
      oled_on();
    }
#endif
    // oled_write_ln(keylog_str, false);
    oled_set_cursor(col, line);
    oled_write(get_keylog_history(), false);

    static char keylog_str[6];

    oled_set_cursor(col, line + 1);
    snprintf(keylog_str, sizeof(keylog_str), "%4u", last_key.keycode);
    oled_write(keylog_str, false);

    oled_set_cursor(col, line + 2);
    snprintf(keylog_str, sizeof(keylog_str), "%2u:%u", last_key.row,
             last_key.col);
    oled_write(keylog_str, false);
  }
}
#endif

void oled_render_logo(void) {
  // https://docs.splitkb.com/hc/en-us/articles/360013811280-How-do-I-convert-an-image-for-use-on-an-OLED-display
  // Image should be vertical (rotated sideways) 32 Ã— 128
  // Code output format: Plain bytes
  // Draw mode: Vertical - 1 bit per pixel
  static const char PROGMEM vtvz_logo[] = {
      // clang-format off
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xe1, 0xfe, 0xfc, 0xf8, 0xc0, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0xc0,
      0xc0, 0xe0, 0xe0, 0xf0, 0xf8, 0xf8, 0xfc, 0xfe, 0xff, 0xff, 0x7f, 0x3f, 0x3f, 0x0f, 0x01, 0x00,
      0x80, 0xc0, 0xe0, 0xe0, 0xf0, 0xf0, 0xf8, 0xf8, 0xfc, 0xfc, 0xfe, 0xff, 0xff, 0x7f, 0x7f, 0x3f,
      0x1f, 0x1f, 0x0f, 0x0f, 0x07, 0x03, 0x03, 0x01, 0x03, 0x1c, 0xf8, 0xf0, 0xf0, 0xe0, 0x80, 0x00,
      0x00, 0x01, 0x03, 0x07, 0x07, 0x0f, 0x1f, 0x1f, 0x3f, 0x7d, 0x79, 0xf8, 0xf0, 0xe0, 0xe0, 0xc0,
      0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0xff, 0xff, 0x7f, 0x1f, 0x07, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x03,
      0x07, 0x07, 0x0f, 0x0f, 0x1e, 0x1e, 0x3e, 0x3e, 0x7f, 0x7f, 0xff, 0xfc, 0xf0, 0xc0, 0x80, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0xc0, 0xc0, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x03, 0x00,
      0xc0, 0xf0, 0xf8, 0xf8, 0xf8, 0xf8, 0xf8, 0xf8, 0xf8, 0xf8, 0xf8, 0xf8, 0xf8, 0xf8, 0xf8, 0xf8,
      0xf8, 0xf8, 0xff, 0xff, 0xff, 0xfe, 0xf8, 0xf0, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x0f, 0x7f, 0x1f, 0x03, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
      0x01, 0x01, 0xff, 0xff, 0xff, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x80, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0xc0, 0xc0, 0xe0, 0xe0, 0xf0, 0xf8,
      0xfc, 0xfe, 0x7f, 0x3f, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x10, 0x38, 0x78, 0xfc, 0xfc, 0x7e, 0x7e, 0x3f, 0x3f, 0x1f, 0x0f, 0x0f, 0x07, 0x07, 0x03, 0x03,
      0xff, 0xf9, 0xf0, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x01, 0x03, 0x0e, 0x1c, 0x30, 0x70, 0x60, 0xe0, 0xe0, 0xe0, 0xf0, 0xf0, 0xfc,
      0xff, 0xff, 0x7f, 0x3f, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0xf8, 0xe0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x07, 0xff, 0xff, 0xff, 0x7e, 0x78, 0xf0, 0xe0, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
      0x0e, 0xfe, 0xfc, 0xf8, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x01, 0x03, 0x0f, 0x1c, 0x38, 0x70, 0xe0, 0xe0,
      0xff, 0xff, 0xff, 0xff, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x03, 0x1f, 0x3f, 0x3f, 0xfc, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03,
      0x07, 0x0f, 0x1f, 0x3f, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
      // clang-format on
  };
  oled_write_raw_P(vtvz_logo, sizeof(vtvz_logo));
}

bool oled_task_user(void) {
  if (is_keyboard_master()) {
    oled_render_layer_state(0, 1);

    static char wpm_str[5] = {};

    uint16_t wpm = get_current_wpm();
    if (wpm >= 100) {
      snprintf(wpm_str, sizeof(wpm_str), "%uwp", wpm);
    } else {
      snprintf(wpm_str, sizeof(wpm_str), "%uwpm", wpm);
    }

    oled_set_cursor(0, 4);
    oled_write(wpm_str, false);

#ifdef OLED_KEYLOGGER_ENABLE
    oled_render_keylog(0, 6);
#endif

    render_pet(0, PET_OFFSET, get_current_wpm());
  } else {
    oled_render_logo();
  }
  return false;
}

void oled_process_record(uint16_t keycode, keyrecord_t *record) {
#ifdef OLED_KEYLOGGER_ENABLE
  process_keylog(keycode, record);
#endif

  process_pet(keycode, record);
}
